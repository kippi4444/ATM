<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title></title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    
    <button id="start">start</button>
    <button id="stop">stop</button>
    <button id="pause">pause</button>
    <button id="createATM">create ATM</button>
    <div class="atms"></div>
    <div class="people"></div>


<script type="text/javascript">

//==============Emmiter================//
class EventEmitter {
  constructor() {
    this._events = {};
  }
  on(evt, listener) {
    (this._events[evt] || (this._events[evt] = [])).push(listener);
    return this;
  }
  emit(evt, arg) {
    (this._events[evt] || []).slice().forEach(lsn => lsn(arg));
  }
}

//===============ATM===============//

class ATM {
  constructor (id) {
    this.id = id;
    this.isFree = false;
    this.atmDelay = self.randomNumber(500, 3000);
  }
  create() {
    this.atms = document.getElementsByClassName('atms')[0];
    this.atmDom = document.createElement('div');
    this.atmDom.className = 'atm';
    this.atmDom.id = this.id;
    this.atms.appendChild(this.atmDom); 
    this.btn = document.createElement('button');
    this.btn.className = 'del';
    this.btn.innerHTML = 'del';
    this.atmDom.appendChild(this.btn); 
  }
  changeStateATM(){
    this.isFree?this.atmDom.classList.add('free'):this.atmDom.classList.remove('free');
  }
}
//===============Man===============//
class Man {
  constructor (id){
    this.id = id;
    this.manDelay = self.randomNumber(1000, 3000);
    this.manDelayOut = self.randomNumber(500, 1000);
  }
}
//===============MVC===============//

class ViewAtm extends EventEmitter {

  constructor () {
    super();
    this.people = document.getElementsByClassName('people')[0];
    this.atms = document.getElementsByClassName('atms')[0];
    this.init();

  }

  init(){
    let body = document.body;
        body.addEventListener('click', (e) => {
          switch (e.target.innerHTML){
            case 'del':
              this.emit('delATM', e);
              break;
            case 'start':
              this.emit('start');
              break;
            case 'stop':
              this.emit('stop');
              break;
            case 'pause':
              this.emit('pause');
              break;
            case 'create ATM':
              this.emit('createAtm');
              break;
          }
        });
  }

  manGoToAtm() {
    this.people.firstChild.remove();
  }

  clearAtmsAndPeople(){
    this.atms.innerHTML = '';
    this.people.innerHTML = '';
  }

  manInAtm(container,id){
    let atm = document.getElementById(container);
    let body = document.body;
    let man = document.createElement('div');
    man.classList.add('move');
    man.classList.add(id);
    man.innerHTML = id;
    atm.appendChild(man);
  }

  manOutAtm(container){
    let manOut = document.getElementsByClassName(`move ${container}`)[0];
    manOut?manOut.remove():'';
  }

  disabledButton(btn){
    let start = document.getElementById('start');
    let stop = document.getElementById('stop');
    let createATM = document.getElementById('createATM');
    btn?(start.disabled = true ) && (stop.disabled = createATM.disabled = false):(stop.disabled = createATM.disabled = true) && (start.disabled = false);
  }

  viewQueue(count) {
    this.manDom = document.createElement('div');
    this.manDom.className = 'mans';
    this.manDom.innerHTML =  count;
    this.people.appendChild(this.manDom);  
  }
}

class ModelAtm extends EventEmitter  {

  constructor () {
    super();
    self = this;
    self.isPause = false;
    self.isPauseOnOff = 0;
    self.parameters = {
      factAtm : 0,
      count : 1,
      countAtm : 2,
      countMan : 5,
      mans : [],
      atms : [],
      timer : null,
      timers : [],
      work : false
    };
  }

  start(){
    self.parameters.work = true;
    self.init();
    this.emit('disableButton', true);
  }

  stop(){
    self.parameters.work = false;
    this.emit('disableButton', false);
  }

  pause(){ //demo
    console.log('pause');
  }

  init() {
    if (!self.parameters.work)return;
    while (self.parameters.factAtm <= self.parameters.countAtm){
      self.parameters.factAtm++;
      self.createAtm();
    }
    self.createMan(self.parameters.countMan);
    self.checkIfAtmFree();
    self.nextManInQueue();
  }

  createAtm() {
    self.parameters.atms.push(new ATM(self.parameters.count));
    self.parameters.count++;
  }

  delATM() {
    event.target.parentElement.remove();
    self.parameters.atms.forEach((el, i) => {
      if (event.target.parentElement.id == el.id) self.parameters.atms.splice(i, 1); 
    })
  }

  createMan(x=1) {
    let i=1;
    while (i < x){
      self.parameters.mans.push(new Man(this.parameters.count));
      this.emit('createMan', this.parameters.count++);
      i++;
      if (self.parameters.mans.length == 1){
         setTimeout(self.checkIfAtmFree, 700)
      }
    }
  }

  nextManInQueue(){
    let delayForNextMan = self.randomNumber(2000, 7000);
    let countMan = self.randomNumber(1, 4);
    if (!self.parameters.work) return;
    self.createMan(countMan); 
    setTimeout(self.nextManInQueue, delayForNextMan);
  }

  randomNumber(min, max){
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  checkIfAtmFree() {            //Логика 
    if (!self.parameters.work) return;
    self.parameters.atms.forEach(el=> {
      if(!el.isFree && self.parameters.mans.length){
        let man = self.parameters.mans.shift(); // забираем человека с очереди
        self.atmWork(el , man);
        setTimeout(() => self.atmFree(el, man), man.manDelay+el.atmDelay);
      }
    });
  }

  atmWork(atm , man){
    atm.isFree = true;  
    this.emit('manGoToAtm');
    atm.changeStateATM(); 
    this.emit('manInAtm', [atm.id, man.id]);
  }

  atmFree(atm, man){
    atm.isFree = false;
    atm.changeStateATM(); 
    this.emit('manOutAtm', man.id);
    setTimeout(self.checkIfAtmFree, man.manDelayOut); 
  }
    
}

class ControllerAtm extends EventEmitter {

  constructor (model, view){
    super();
    this.model = model;
    this.view = view;

    view.on('delATM', (element) => this.model.delATM(element));
    view.on('start', () => this.model.start());
    view.on('stop', () => this.model.stop());
    view.on('pause', () => this.model.pause());
    view.on('createAtm', () => this.model.createAtm());
    model.on('createMan', (count) => this.view.viewQueue(count));
    model.on('manGoToAtm', () => this.view.manGoToAtm());
    model.on('manInAtm', (allId) => this.view.manInAtm(...allId));
    model.on('manOutAtm', (id) => this.view.manOutAtm(id));
    model.on('disableButton', (state) => this.view.disabledButton(state));
  }

}


let model = new ModelAtm;
let controller = new ControllerAtm(model, new ViewAtm);

// model.start();
// document.addEventListener("DOMContentLoaded",controller.init , false);



</script>
    </main>
  </body>
</html>