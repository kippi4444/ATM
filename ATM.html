<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title></title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <button id="createATM">create ATM</button>
    <div class="atms">
    </div>
    <div class="people">
      
    </div>

<script type="text/javascript">

class ViewAtm {

  constructor () {
    this.people = document.getElementsByClassName('people')[0];
  }

  clearMan() {
    this.people.innerHTML = '';
  };

  manOut() {
    this.people.firstChild.remove();
  };

  viewMan(count) {
    this.colorMan = Math.floor(Math.random() * (255 - 0 + 1)) + 0;
    this.manDom = document.createElement('div');
    this.manDom.className = 'mans';
    this.manDom.innerHTML =  count;
    this.manDom.setAttribute("style", `background-color: rgb(0, ${this.colorMan}, 180, 0.9)`);
    this.people.appendChild(this.manDom);  
    console.log("create")
  };

}

class ModelAtm{

  constructor (view) {
    self = this;
    self.view = view;
    self.atms = document.getElementsByClassName('atms')[0];
    self.i=0;
    self.k=0;
    this.count = 0;
    self.countAtm = 2;
    self.countMan = 7;
    self.mans = [];
    self.atms = [];
    self.atmDelay = Math.floor(Math.random() * (1000 - 500 + 1)) + 500;
  }

  init() {
    while (self.i <= self.countAtm){
      self.i++;
      self.createATM();
    }
    self.createMan(self.countMan);
    self.checkAtmFree();
  };

  createATM() {
    class ATM {
      constructor () {
        this.atms = document.getElementsByClassName('atms')[0];
        this.isFree = false;
        this.atmDelay = Math.floor(Math.random() * (1000 - 500 + 1)) + 500;
        this.create();
      }
      create() {
        this.atmDom = document.createElement('div');
        this.atmDom.className = 'atm';
        this.atms.appendChild(this.atmDom); 
        this.btn = document.createElement('button');
        this.btn.className = 'del';
        this.btn.innerHTML = 'del';
        this.atmDom.appendChild(this.btn); 
      }
      changeStateATM(state){
        state?this.atmDom.classList.add('free'):this.atmDom.classList.remove('free');
      }
    }
    self.atms.push(new ATM);
  };

  delATM() {
    event.target.parentElement.remove();
    self.atms.shift(this);
    console.log( self.atms);
  };
  
  createMan(x=1) {
    let i=1;
    class Man {
      constructor (){
        this.manDelay = Math.floor(Math.random() * (3000 - 1000 + 1)) + 1000;
        this.manDelayOut = Math.floor(Math.random() * (1000 - 500 + 1)) + 500;
      }
    }
    while (i <= x){
      self.mans.push(new Man);
      self.view.viewMan(this.count++);
      i++;
    }
  };

  checkAtmFree() {
    self.createMan();
    if (self.mans.length>2){
      self.atms.forEach(el=> {
        if(!el.isFree){
          el.isFree = true;
          let man=self.mans.shift(0);
          el.changeStateATM(true);
          self.view.manOut();
          setTimeout(() => { 
            el.isFree = false;
            el.changeStateATM(false);
            setTimeout(self.checkAtmFree, man.manDelayOut);
          }, man.manDelay+self.atmDelay);
        } 
      });
    } else {
      self.checkAtmFree();
    };
  };

}

class ControllerAtm{

  constructor (model){
    this.model = model;
    this.init();
  }

  init(){
    let btnCreateAtm = document.getElementById('createATM');
    btnCreateAtm.addEventListener("click", this.model.createATM);
    setInterval(()=>{
      let btnDelAtm = document.getElementsByClassName('del');
      for (let b=0; b < btnDelAtm.length; b++) {
        btnDelAtm[b].addEventListener("click", this.model.delATM , false);
      }
    },0);
  };

}


let view = new ViewAtm;
let model = new ModelAtm(view);
let controller = new ControllerAtm(model);

model.init();

</script>
    </main>
  </body>
</html>