<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title></title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <button id="createATM">create ATM</button>
    <div class="atms">
    </div>
    <div class="people">
      
    </div>

<script type="text/javascript">



class ViewAtm {

  constructor () {
    this.people = document.getElementsByClassName('people')[0];
  }

  clearBlockMans() {
    this.people.innerHTML = '';
  };

  manOut() {
    this.people.firstChild.remove();
  };

  viewMan(count) {

    this.colorMan = Math.floor(Math.random() * (255 - 0 + 1)) + 0;
    this.manDom = document.createElement('div');
    this.manDom.className = 'mans';
    this.manDom.innerHTML =  count;
    this.manDom.setAttribute("style", `background-color: rgb(0, ${this.colorMan}, 180, 0.9)`);
    this.people.appendChild(this.manDom);  
  };

}

class ModelAtm{

  constructor (view) {
    self = this;
    self.view = view;
    self.atms = document.getElementsByClassName('atms')[0];
    self.i=0;
    self.k=0;
    self.count = 0;
    self.countAtm = 2;
    self.countMan = 5;
    self.mans = [];
    self.atms = [];
    self.atmDelay = self.randomNumber(500, 1000); 
    self.timer = null;
    self.timers = [];
  }

  init() {
    while (self.i <= self.countAtm){
      self.i++;
      self.createATM();
    }
    self.createMan(self.countMan);
    self.checkIfAtmFree();
    self.nextMan();
  };

  createATM() {

    class ATM {

      constructor () {
        this.atms = document.getElementsByClassName('atms')[0];
        this.isFree = false;
        this.atmDelay = self.randomNumber(500, 3000);
        this.create();
      }

      create() {
        this.atmDom = document.createElement('div');
        this.atmDom.className = 'atm';
        this.atms.appendChild(this.atmDom); 
        this.btn = document.createElement('button');
        this.btn.className = 'del';
        this.btn.innerHTML = 'del';
        this.atmDom.appendChild(this.btn); 
      };

      changeStateATM(state){
        state?this.atmDom.classList.add('free'):this.atmDom.classList.remove('free');
      };

    }

    self.atms.push(new ATM);

  };

  delATM() {

    event.target.parentElement.remove();
    self.atms.shift(this);
    console.log(self.atms);

  };
  
  createMan(x=1) {

    let i=1;

    class Man {

      constructor (){
        this.manDelay = self.randomNumber(1000, 3000);
        this.manDelayOut = self.randomNumber(500, 2000);
      }

    }

    while (i <= x){
      self.mans.push(new Man);
      self.view.viewMan(this.count++);
      i++;
    }

  };

  nextMan(){
    let delayForNextMan = self.randomNumber(2000, 8000);
    let countMan = self.randomNumber(1, 4);
    setTimeout(()=>{
      self.createMan(countMan);
      self.nextMan();
    },delayForNextMan);
    if (!self.timers.length){
      setTimeout(self.checkIfAtmFree, 1000);
    }
  };

  randomNumber(min, max){
    return Math.floor(Math.random() * (max - min + 1)) + min;
  };


  checkIfAtmFree() {            //Логика 
                
    if (self.mans.length){
      self.atms.forEach(el=> {
        if(!el.isFree && self.mans.length){ 
          let man=self.mans.shift(0); // забираем человека с очереди
          el.isFree = true;  // ставим флаг что банкомат занят
          el.changeStateATM(true); // меняем цвет банкомата на красный
          self.view.manOut(); // перерисовываем очередь
         
          setTimeout(() => { // запускаем имтацию работы с банкоматом
            el.isFree = false;  //банкомат свободен
            el.changeStateATM(false); //меняем цвет на зеленый
            self.timer = setTimeout(()=>{
              self.checkIfAtmFree();
              self.timers.shift(0);
            }, man.manDelayOut); // запускаем проверку на наличие людей для освободившегося банкомата
            self.timers.push(self.timer);
          }, man.manDelay+self.atmDelay);
        } 
      });
    } else {self.view.clearBlockMans();
      // console.log(self.mans);
      // console.log(self.mans.length);
      // console.log(self.mans[0]);
    }
      // setTimeout(self.checkIfAtmFree, 500);
      
  };

}

class ControllerAtm{

  constructor (model){
    this.model = model;
    this.init();
  }

  init(){
    let btnCreateAtm = document.getElementById('createATM');
    btnCreateAtm.addEventListener("click", this.model.createATM);
    setTimeout(()=>{                                               //ждем пока отрисует людей
      let btnDelAtm = document.getElementsByClassName('del');
      for (let b=0; b < btnDelAtm.length; b++) {
        btnDelAtm[b].addEventListener("click", this.model.delATM , false);
      }
    },0);
  };

}


let view = new ViewAtm;
let model = new ModelAtm(view);
let controller = new ControllerAtm(model);

model.init();



</script>
    </main>
  </body>
</html>